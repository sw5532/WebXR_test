<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Basic WebXR Depth Test - Final Fix</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
        }

        #ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #glCanvas {
            width: 100%;
            height: 100%;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
            color: white;
            text-shadow: 2px 2px 3px black;
        }

        .info-box,
        #start-button {
            pointer-events: auto;
        }

        .info-box {
            margin: 1em;
            padding: 1em;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            font-size: 1.1em;
        }

        #start-button {
            margin: 1em auto;
            padding: 12px 24px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div id="ar-container"><canvas id="glCanvas"></canvas></div>
    <div id="overlay">
        <div class="info-box">
            <div>Status: <span id="status">Ready</span></div>
            <div>Depth at Center: <span id="depth-display">N/A</span></div>
        </div>
        <button id="start-button">Start AR</button>
    </div>

    <script>
        const startButton = document.getElementById('start-button');
        const statusEl = document.getElementById('status');
        const depthEl = document.getElementById('depth-display');
        const overlayEl = document.getElementById('overlay');
        const glCanvas = document.getElementById('glCanvas');

        let xrSession = null;
        let gl = null;
        let xrReferenceSpace = null;
        let hasDepthFeature = false;

        document.addEventListener('DOMContentLoaded', () => {
            if (!navigator.xr) {
                statusEl.textContent = "WebXR not supported by this browser.";
                startButton.disabled = true;
                return;
            }
            startButton.addEventListener('click', onStartButtonClick);
        });

        function onStartButtonClick() {
            if (xrSession) {
                xrSession.end();
            } else {
                if (window.location.protocol !== 'https:') {
                    statusEl.textContent = "WebXR requires a secure context (HTTPS).";
                    return;
                }
                requestARSession();
            }
        }

        async function requestARSession() {
            statusEl.textContent = "Requesting AR session...";
            try {
                const session = await navigator.xr.requestSession("immersive-ar", {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['dom-overlay', 'depth-sensing'],
                    domOverlay: { root: overlayEl },
                    depthSensing: {
                        usagePreference: ["gpu-optimized", "cpu-optimized"],
                        dataFormatPreference: ["float32", "luminance-alpha"]
                    }
                });
                onSessionStarted(session);
            } catch (error) {
                console.error("WebXR session request failed:", error);
                statusEl.textContent = `Error: ${error.message}`;
            }
        }

        async function onSessionStarted(session) {
            xrSession = session;
            startButton.textContent = "Exit AR";
            session.addEventListener('end', onSessionEnded);

            if (session.depthUsage) {
                hasDepthFeature = true;
                statusEl.textContent = `AR Active | Depth format: ${session.depthDataFormat} | usage:${session.depthUsage}`;
            } else {
                hasDepthFeature = false;
                statusEl.textContent = "AR Active (Depth Sensing NOT supported/granted)";
                depthEl.textContent = "Not supported by device or browser.";
            }

            try {
                gl = glCanvas.getContext('webgl', { xrCompatible: true });
                await gl.makeXRCompatible();
                const glLayer = new XRWebGLLayer(xrSession, gl);
                session.updateRenderState({ baseLayer: glLayer });
            } catch (e) {
                statusEl.textContent = `Error: Could not create WebGL layer. ${e.message}`;
                session.end();
                return;
            }

            xrReferenceSpace = await session.requestReferenceSpace('local-floor');
            session.requestAnimationFrame(onXRFrame);
        }

        function onSessionEnded() {
            xrSession = null;
            gl = null;
            statusEl.textContent = "Ready";
            startButton.textContent = "Start AR";
            depthEl.textContent = "N/A";
            hasDepthFeature = false;
        }

        function onXRFrame(time, frame) {
            if (!xrSession) return;
            xrSession.requestAnimationFrame(onXRFrame);

            const pose = frame.getViewerPose(xrReferenceSpace);
            if (!pose) {
                depthEl.textContent = "Tracking lost. Point at a textured surface.";
                return;
            }

            const glLayer = xrSession.renderState.baseLayer;
            gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
            gl.clearColor(0, 0, 0, 0);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            const view = pose.views[0];
            if (view) {
                const viewport = glLayer.getViewport(view);
                gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);

                if (hasDepthFeature) {
                    const depthInfo = frame.getDepthInformation(view);
                    if (depthInfo) {
                        // Check that the data buffer itself exists and has been allocated.
                        if (depthInfo.data && depthInfo.data.byteLength > 0) {

                            // --- THE CRITICAL FIX IS HERE ---
                            // Before using width/height, ensure they are validly populated.
                            if (depthInfo.width > 0 && depthInfo.height > 0) {
                                const centerX = Math.floor(depthInfo.width / 2);
                                const centerY = Math.floor(depthInfo.height / 2);

                                // Now this call is safe.
                                const depthInMeters = depthInfo.getDepthInMeters(centerX, centerY);

                                if (depthInMeters) {
                                    statusEl.textContent = "SUCCESS!";
                                    depthEl.textContent = `${depthInMeters.toFixed(2)}m`;
                                } else {
                                    // This can happen if the center pixel has no depth data (e.g., pointed at the sky).
                                    depthEl.textContent = "Depth unknown at center";
                                }
                            } else {
                                // We have a data buffer but no dimensions yet. Wait for the next frame.
                                depthEl.textContent = "Finalizing data format...";
                            }
                        } else {
                            depthEl.textContent = "Waiting for data buffer...";
                        }
                    } else {
                        depthEl.textContent = "Initializing... Scan your environment.";
                    }
                }
            }
        }
    </script>
</body>

</html>