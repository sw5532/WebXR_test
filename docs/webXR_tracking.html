<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Native WebXR Image Tracking</title>
  <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
  <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
  <style>
    body { margin: 0; }
    #info { position: absolute; top: 10px; width: 100%; text-align: center; z-index: 100; color: white; font-family: monospace; }
  </style>
</head>
<body>
  <div id="info">Point camera at the marker image.</div>
  <button id="start-button" style="position:absolute; bottom: 20px; left: 50%; transform: translateX(-50%);">Start AR</button>

  <script>
    document.getElementById('start-button').addEventListener('click', activateXR);

    async function activateXR() {
      const canvas = document.createElement("canvas");
      document.body.appendChild(canvas);
      const gl = canvas.getContext("webgl", { xrCompatible: true });
      const scene = new THREE.Scene();
      const infoElement = document.getElementById('info');

      // --- Load the image to be tracked ---
      let trackedImageBitmap;
      try {
        const response = await fetch('https://immersive-web.github.io/webxr-samples/media/images/sunflower.jpg');
        const blob = await response.blob();
        trackedImageBitmap = await createImageBitmap(blob);
      } catch (e) {
        infoElement.innerText = "Error: Failed to load marker image.";
        console.error("Failed to load image: ", e);
        return;
      }
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(10, 15, 10);
      scene.add(directionalLight);
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const renderer = new THREE.WebGLRenderer({ alpha: true, canvas: canvas, context: gl });
      renderer.autoClear = false;

      const camera = new THREE.PerspectiveCamera();
      camera.matrixAutoUpdate = false;

      // --- Request a session with image-tracking ---
      const session = await navigator.xr.requestSession("immersive-ar", {
        requiredFeatures: ['image-tracking'],
        trackedImages: [
          {
            image: trackedImageBitmap,
            widthInMeters: 0.15 // Specify the real-world width of your marker
          }
        ]
      });
      session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

      const referenceSpace = await session.requestReferenceSpace('local');

      // --- Load the 3D model ---
      const loader = new THREE.GLTFLoader();
      let flowerModel;
      loader.load("https://immersive-web.github.io/webxr-samples/media/gltf/sunflower/sunflower.gltf", (gltf) => {
        flowerModel = gltf.scene;
        flowerModel.scale.set(0.1, 0.1, 0.1);
        flowerModel.visible = false; // Initially hidden
        scene.add(flowerModel);
      });

      const onXRFrame = (time, frame) => {
        session.requestAnimationFrame(onXRFrame);
        gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);

        const pose = frame.getViewerPose(referenceSpace);
        if (pose) {
          const view = pose.views[0];
          const viewport = session.renderState.baseLayer.getViewport(view);
          renderer.setSize(viewport.width, viewport.height);

          camera.matrix.fromArray(view.transform.matrix);
          camera.projectionMatrix.fromArray(view.projectionMatrix);
          camera.updateMatrixWorld(true);

          // --- Get tracking results ---
          const results = frame.getTrackedImages();

          if (flowerModel) {
            let imageFound = false;
            // Loop through the results
            for (const result of results) {
              // The result's index matches the order in the trackedImages array
              const imagePose = frame.getPose(result.imageSpace, referenceSpace);
              if (imagePose) {
                // Update the model's position and orientation
                flowerModel.position.copy(imagePose.transform.position);
                flowerModel.quaternion.copy(imagePose.transform.orientation);
                flowerModel.visible = true;
                imageFound = true;
                infoElement.innerText = `Tracking state: ${result.trackingState}`;
              }
            }
            // Hide the model if the image is not found
            if (!imageFound) {
              flowerModel.visible = false;
            }
          }

          renderer.render(scene, camera);
        }
      };
      session.requestAnimationFrame(onXRFrame);
    }
  </script>
</body>
</html>