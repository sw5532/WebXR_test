<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebXR QR Code Tracking</title>
  <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
  <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #info { position: absolute; top: 10px; width: 100%; text-align: center; z-index: 100; color: white; font-family: monospace; font-size: 16px; background-color: rgba(0,0,0,0.5); padding: 5px;}
    button { font-size: 18px; padding: 10px; position:absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
  </style>
</head>
<body>
  <div id="info">Point camera at the QR code.</div>
  <button id="start-button">Start AR</button>

  <script>
    document.getElementById('start-button').addEventListener('click', activateXR);

    async function activateXR() {
      document.getElementById('start-button').style.display = 'none';
      const canvas = document.createElement("canvas");
      document.body.appendChild(canvas);
      const gl = canvas.getContext("webgl", { xrCompatible: true });
      const scene = new THREE.Scene();
      const infoElement = document.getElementById('info');

      // --- <<< CHANGED: URL now points to a QR code image ---
      const markerUrl = "https://i.imgur.com/8p7tP0F.png";
      let trackedImageBitmap;
      try {
        infoElement.innerText = "Downloading QR code marker...";
        const response = await fetch(markerUrl);
        const blob = await response.blob();
        trackedImageBitmap = await createImageBitmap(blob);
        infoElement.innerText = "Marker downloaded. Starting XR...";
      } catch (e) {
        infoElement.innerText = "Error: Failed to load marker image.";
        console.error("Failed to load image: ", e);
        document.getElementById('start-button').style.display = 'block';
        return;
      }
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(10, 15, 10);
      scene.add(directionalLight);
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const renderer = new THREE.WebGLRenderer({ alpha: true, canvas: canvas, context: gl });
      renderer.autoClear = false;

      const camera = new THREE.PerspectiveCamera();
      camera.matrixAutoUpdate = false;

      const session = await navigator.xr.requestSession("immersive-ar", {
        requiredFeatures: ['image-tracking'],
        trackedImages: [
          {
            image: trackedImageBitmap,
            // --- <<< CRITICAL: Change this value to the real-world width of your QR code ---
            widthInMeters: 0.1 // e.g., 0.1 for 10cm
          }
        ]
      });
      infoElement.innerText = "Point your camera at the QR code.";
      session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

      const referenceSpace = await session.requestReferenceSpace('local');

      const loader = new THREE.GLTFLoader();
      let flowerModel;
      loader.load("https://immersive-web.github.io/webxr-samples/media/gltf/sunflower/sunflower.gltf", (gltf) => {
        flowerModel = gltf.scene;
        // Adjust scale to look good on the marker
        flowerModel.scale.set(0.2, 0.2, 0.2);
        flowerModel.visible = false;
        scene.add(flowerModel);
      });

      const onXRFrame = (time, frame) => {
        session.requestAnimationFrame(onXRFrame);
        gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);

        const pose = frame.getViewerPose(referenceSpace);
        if (pose) {
          const view = pose.views[0];
          const viewport = session.renderState.baseLayer.getViewport(view);
          renderer.setSize(viewport.width, viewport.height);

          camera.matrix.fromArray(view.transform.matrix);
          camera.projectionMatrix.fromArray(view.projectionMatrix);
          camera.updateMatrixWorld(true);

          const results = frame.getTrackedImages();

          if (flowerModel) {
            let imageFound = false;
            for (const result of results) {
              const imagePose = frame.getPose(result.imageSpace, referenceSpace);
              if (imagePose) {
                flowerModel.position.copy(imagePose.transform.position);
                flowerModel.quaternion.copy(imagePose.transform.orientation);
                flowerModel.visible = true;
                imageFound = true;
                infoElement.innerText = `Tracking state: ${result.trackingState}`;
              }
            }
            if (!imageFound) {
              flowerModel.visible = false;
            }
          }
          renderer.render(scene, camera);
        }
      };
      session.requestAnimationFrame(onXRFrame);
    }
  </script>
</body>
</html>